# efx-libs Monorepo – Version 1.1.0

## 1. High-Level Overview

The **efx-libs** repository is a **pnpm monorepo** that serves two purposes:

1. A **full demo application** built with **TanStack Start** showcasing advanced dashboards using ECharts.
2. A set of **four reusable npm packages** under the `@efxlab` scope that extract the charting and layout logic into standalone libraries:

- `@efxlab/chart-core` – framework-agnostic chart utilities and types
- `@efxlab/chart-react` – React chart components
- `@efxlab/layout-core` – framework-agnostic layout utilities and presets
- `@efxlab/layout-react` – React layout components

The monorepo lets you:

- Iterate on the core libraries and demo app in one place.
- Publish the libraries independently to npm.
- Use the demo app as a reference implementation and visual testbed.

---

## 2. Monorepo Structure (Top-Level)

At a high level:

- `packages/` – **npm packages** (library code published under `@efxlab/*`)
  - `efx-chart-core/` → `@efxlab/chart-core`
  - `efx-chart-react/` → `@efxlab/chart-react`
  - `efx-layout-core/` → `@efxlab/layout-core`
  - `efx-layout-react/` → `@efxlab/layout-react`
- `src/` – **demo application** using the above packages
  - `components/` – demo-specific UI, chart wrappers, and layout helpers
  - `routes/` – pages for examples, dashboards, and demos
  - `lib/`, `hooks/`, `providers/` – shared app utilities and context

The monorepo is managed with:

- **pnpm workspaces** – dependency and script orchestration
- **Changesets** – versioning and publishing to npm
- **tsup** – library bundling (CJS, ESM, and `.d.ts` output)

---

## 3. Version Matrix (Current)

Monorepo root:

- **efx-libs**: `1.1.0`

Published packages:

| Package Name              | Version | Location                            | Description                                  |
|---------------------------|---------|--------------------------------------|----------------------------------------------|
| `@efxlab/chart-core`      | 0.2.0   | `packages/efx-chart-core`           | Core chart types, templates, utilities       |
| `@efxlab/chart-react`     | 0.2.0   | `packages/efx-chart-react`          | React chart components & layout integration  |
| `@efxlab/layout-core`     | 0.2.0   | `packages/efx-layout-core`          | Core layout types & presets                  |
| `@efxlab/layout-react`    | 0.2.0   | `packages/efx-layout-react`         | React layout components                      |

Demo application:

- **App in `src/`** – not published as a package; version is implicitly tied to the root `1.1.0`.

---

## 4. Module-by-Module Breakdown

### 4.1 `@efxlab/chart-core` (0.2.0)

**Location:** `packages/efx-chart-core`  
**Type:** Framework-agnostic **chart core** library

#### Purpose

Provide all **non-React**, **non-framework** logic needed to build multi-chart dashboards with ECharts:

- Strict TypeScript types for chart layouts and configuration.
- Template-driven chart layout definitions using ASCII / grid-like templates.
- Data generators for demos and testing.
- Utility functions to build ECharts `option` objects from higher-level layouts.

#### Core Responsibilities

- **Layout templates for charts** – definitions of how multiple charts fit into a grid dashboard:
  - Areas (e.g., `"header"`, `"main"`, `"sidebar"`)
  - Rows/columns
  - Gaps and padding
- **Parsing & normalization utilities**:
  - Normalize padding configuration into CSS/grid-friendly values.
  - Translate human-readable templates into structures ECharts can use.
- **Option builder utilities**:
  - Convert template + sections → ECharts `grid`, `xAxis`, `yAxis`, and `series` arrays.
- **Demo data generators**:
  - Functions to produce realistic sample data (e.g., sales, time series) for charts.

#### Consumers

- Directly by **`@efxlab/chart-react`** (via imports)
- Potentially by **non-React** projects that want to use the same core logic with another UI framework.

---

### 4.2 `@efxlab/chart-react` (0.2.0)

**Location:** `packages/efx-chart-react`  
**Type:** React library built on top of `@efxlab/chart-core`

#### Purpose

Expose **React components** that make it easy to build multi-chart ECharts dashboards using the core types and utilities from `@efxlab/chart-core`.

#### Core Responsibilities

- **React components**:
  - `EfxChart` – a declarative wrapper for a single chart, using ECharts under the hood.
  - `EfxChartsLayout` – a dashboard-level component that:
    - Consumes a layout template from `@efxlab/chart-core`
    - Accepts multiple `EfxChart` children
    - Arranges them according to the template

- **Hooks & helpers**:
  - `useEChartsInstance` – manage ECharts lifecycle, resizing, and interactions.
  - `useResizeObserver` – adjust charts to container size changes.
  - `useStreamingData` – manage streaming / progressive data updates.

- **Integration with `@efxlab/chart-core`**:
  - Reuse types like `EfxLayoutTemplate`, `EfxChartSectionConfig`, etc.
  - Use option builders to ensure ECharts configuration stays in sync with layout definitions.

#### Dependencies & Interactions

- **Depends on:** `@efxlab/chart-core` (runtime and types)
- **Peer dependencies:** 
  - React (`react` / `react-dom`)
  - ECharts
- **Used by:** 
  - The demo app in `src/` (various dashboards and pages)
  - External projects that need React-based dashboards.

---

### 4.3 `@efxlab/layout-core` (0.2.0)

**Location:** `packages/efx-layout-core`  
**Type:** Framework-agnostic **layout core** library

#### Purpose

Provide **layout-related types, presets, and utilities** that are independent of React:

- Describe dashboards using **CSS Grid-like** templates.
- Normalize padding/gap settings.
- Supply reusable layout presets for common dashboard patterns.

#### Core Responsibilities

- **Layout models**:
  - `LayoutTemplate` – definition of areas, rows, columns, and gaps.
  - Responsive layout model tying templates to breakpoints.

- **Presets**:
  - Common dashboard layouts: analytics, comparison, monitoring, reporting, etc.

- **Utilities**:
  - `buildPaddingStyle`, `normalizeGap` – convert friendly layout configs into actual CSS values.
  - Normalization helpers for sizes, paddings, gaps.

#### Consumers

- **`@efxlab/layout-react`** – uses the types & utilities to render layouts as React components.
- Any other framework that wants to share the same layout semantics.

---

### 4.4 `@efxlab/layout-react` (0.2.0)

**Location:** `packages/efx-layout-react`  
**Type:** React library built on top of `@efxlab/layout-core`

#### Purpose

Expose **React-friendly layout components** that implement the layout semantics and presets from `@efxlab/layout-core`.

#### Core Responsibilities

- **React layout components**:
  - `EfxLayout` – a general-purpose CSS Grid layout wrapper driven by a `LayoutTemplate`:
    - Areas become grid regions.
    - Children map to areas via `data-area` or specific wrappers.
  - `EfxGrid` – simpler utility grid for evenly spaced content.
  - `EfxResponsiveLayout` – layout that switches templates based on breakpoints.

- **Hook integration with core**:
  - Use `buildPaddingStyle`, `normalizeGap`, and other utility functions from `@efxlab/layout-core` to ensure consistent spacing and grid behavior.

#### Dependencies & Interactions

- **Depends on:** `@efxlab/layout-core` (runtime + types)
- **Peer dependencies:** React
- **Used by:** 
  - The demo app's layout system in `src/components/layout/`
  - Any React project needing reusable dashboard layouts independent of charts.

---

### 4.5 Demo Application in `src/`

**Location:** `src/`  
**Type:** TanStack Start app (demo / reference implementation)

#### Purpose

Provide a **full-featured demo** showcasing:

- How to use the `@efxlab/*` packages in a real app.
- Multiple dashboard use cases (sales, performance, financial, marketing, operations).
- SSR-safe ECharts integration patterns.
- Advanced layout patterns built with `EfxLayout` and `EfxChartsLayout`.

#### Key Areas

- `src/components/`:
  - `charts/` – composed chart components using ECharts directly.
  - `layout/` – demo-oriented wrappers around layout components (DashboardLayout, DashboardGrid, etc.).
  - `controls/` – dashboard-level control bar, layout navigator, theme switcher.
- `src/routes/`:
  - `basic-echarts.tsx` – basic charts demo.
  - `layout-echarts.tsx` – layout systems demo.
  - `dashboard.tsx` & `examples/*` – domain-specific dashboards.
- `src/lib/`, `src/hooks/`, `src/providers/`:
  - Theme management, data generation, responsive helpers, custom ECharts series.

The demo uses the **published libraries** as if it were an external client, validating the libraries' public APIs.

---

## 5. Package Relationships and Dependencies

Conceptual dependency graph:

- **Core → React**:
  - `@efxlab/chart-core` → used by `@efxlab/chart-react`
  - `@efxlab/layout-core` → used by `@efxlab/layout-react`

- **React packages → Demo app**:
  - `@efxlab/chart-react` → imported in `src` routes and components
  - `@efxlab/layout-react` → imported in `src` layout components and pages

- **External dependencies**:
  - ECharts and `echarts-for-react` used primarily by `@efxlab/chart-react` and demo components.
  - React is a peer dependency of both React packages and used by the demo app.

In text form:

```
@efxlab/chart-core
  ↓ (provides types & utilities)
@efxlab/chart-react
  ↓ (used by)
src/ (demo app)
```

```
@efxlab/layout-core
  ↓ (provides types & utilities)
@efxlab/layout-react
  ↓ (used by)
src/ (demo app)
```

This separation allows:

- **Core libraries** to remain framework-agnostic.
- **React libraries** to focus on UI and lifecycle integration.
- The **demo app** to act purely as a consumer, validating the public APIs.

---

## 6. Key Features and Capabilities

**Overall system capabilities:**

- **Multi-chart ECharts dashboards**
  - Support for multiple grids, dual axes, composed series, and matrix layouts.
  - Template-driven layout for complex dashboards.

- **Reusable layout system**
  - Layout templates and presets for common dashboard patterns.
  - Responsive layouts switching between configurations based on breakpoints.
  - Grid and dashboard-specific helpers (`EfxLayout`, `EfxGrid`, `EfxResponsiveLayout`).

- **Type-safe configuration**
  - Strong TypeScript types for chart layouts, sections, events, and data.
  - Shared models between core and React layers.

- **SSR-safe chart integration**
  - Patterns for lazy-loading ECharts in SSR environments.
  - Example implementations in demo routes.

- **Theming & UI integration**
  - Integration with RSuite and Tailwind for consistent visual style.
  - Theme-aware chart rendering via context.

- **Publishing-ready libraries**
  - Bundled as ESM + CJS with `.d.ts` declarations via `tsup`.
  - Published under `@efxlab/*` with clear `exports` and peer dependency definitions.
  - Managed via Changesets for versioning and release workflows.

---

## 7. Intended Use Cases and Target Audience

**Target audience:**

- **Library Consumers**
  - Frontend engineers who want to build **dashboard-style UIs** using React and ECharts.
  - Teams who want **reusable, typed chart + layout components** without pulling in the entire demo app.

- **Contributors/Maintainers**
  - Developers working on the `@efxlab/*` libraries.
  - Contributors improving the demo app as a reference implementation.

**Primary use cases:**

1. **As a library user**:
   - Install `@efxlab/chart-react` and `@efxlab/layout-react` in a React app.
   - Use `@efxlab/chart-core` and `@efxlab/layout-core` to share layout and chart semantics across different frameworks or platforms.

2. **As a monorepo maintainer**:
   - Add features or fix bugs in any of the four libraries.
   - Validate changes via the demo app.
   - Use the Changesets workflow to version and publish updated packages.

3. **As a reference/demo**:
   - Study concrete implementations for:
     - Multi-chart ECharts dashboards
     - SSR-safe chart loading
     - Complex layout composition
   - Use example routes in `src/routes/` as templates for your own applications.

---

## 8. Installation and Development

### For External Users (npm packages)

```bash
# Install chart packages
npm install @efxlab/chart-core @efxlab/chart-react echarts

# Install layout packages  
npm install @efxlab/layout-core @efxlab/layout-react
```

Quick example:

```tsx
import { EfxChartsLayout, EfxChart } from '@efxlab/chart-react'

const template = {
  areas: [['kpi', 'chart']],
  columns: ['1fr', '2fr'],
  rows: ['1fr'],
}

function Dashboard() {
  return (
    <EfxChartsLayout template={template}>
      <EfxChart
        id="kpi"
        title="Revenue"
        option={{ series: [{ type: 'bar', data: [100, 200, 150] }] }}
      />
      <EfxChart
        id="chart"
        title="Trend"
        option={{
          xAxis: { type: 'category', data: ['A', 'B', 'C'] },
          yAxis: { type: 'value' },
          series: [{ type: 'line', data: [10, 20, 15] }]
        }}
      />
    </EfxChartsLayout>
  )
}
```

### For Monorepo Development

```bash
# Clone and setup
git clone <repository-url>
cd efx-libs
pnpm install

# Development
pnpm dev                    # Start demo app
pnpm build:packages         # Build all packages
pnpm clean:packages         # Clean package dist folders

# Versioning and Publishing
pnpm changeset              # Create changeset
pnpm changeset:version      # Bump versions
pnpm changeset:publish      # Publish to npm

# Quality
pnpm check                  # Run linting
pnpm test                   # Run tests
```

---

## 9. Package Links

- **npm Registry:**
  - [@efxlab/chart-core](https://www.npmjs.com/package/@efxlab/chart-core)
  - [@efxlab/chart-react](https://www.npmjs.com/package/@efxlab/chart-react)
  - [@efxlab/layout-core](https://www.npmjs.com/package/@efxlab/layout-core)
  - [@efxlab/layout-react](https://www.npmjs.com/package/@efxlab/layout-react)

- **Package READMEs:**
  - [packages/efx-chart-core/README.md](./packages/efx-chart-core/README.md)
  - [packages/efx-chart-react/README.md](./packages/efx-chart-react/README.md)
  - [packages/efx-layout-core/README.md](./packages/efx-layout-core/README.md)
  - [packages/efx-layout-react/README.md](./packages/efx-layout-react/README.md)

---

This document is intended as a **developer-facing overview** of the **structure, roles, and relationships** of all modules in the **efx-libs** monorepo at **version 1.1.0**, with library packages at **0.2.0**.
